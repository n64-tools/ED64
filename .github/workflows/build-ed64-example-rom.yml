name: Build ED64 Example ROM
 
on: [push] #, pull_request]
# on:
#   push:
#     paths:
#       - '/**/ED64-XIO/*'
#   pull_request:
#     paths:
#       - '/**/ED64-XIO/*'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        releasetype: [ 'debug', 'release' ]
    steps:
      - uses: actions/checkout@v2
        name: Checkout Code
        with:
          path: xio-sample-repo
      - name: Checkout libdragon repo
        uses: actions/checkout@v2
        with:
          repository: dragonminded/libdragon
          path: libdragon-repo
          ref: '89d17be8563a44a9b95873d436832a1222757cdc'

      - name: Setup Build environment
        working-directory: xio-sample-repo
        run: |
          ls
          mkdir -p ED64-XIO/bin && mkdir -p ED64-XIO/bin/release && mkdir -p ED64-XIO/bin/debug && mkdir obj

      - name: patch libdragon make (workaround ignore warnings as errors)
        working-directory: libdragon-repo
        run: |
          sed -z -i.bak 's/ -Wall -Werror / /' ./Makefile
          ls

      - name: check current work dir
        working-directory: ${{ github.workspace }}
        run: |
          ls
          echo "swith to libdragon"
          cd ./libdragon-repo/
          ls
          echo "switch to XIO"
          cd ./../xio-sample-repo/ED64-XIO/
          ls


      - name: Buid libdragon and ROM
        working-directory: ${{ github.workspace }}
        run: >-
          docker run
          --mount type=bind,source=$(pwd),target=${{ github.workspace }}/
          --workdir=${{ github.workspace }}/
          ghcr.io/dragonminded/libdragon:latest
          ls &&
          cd ./libdragon-repo/ &&
          make libdragon &&
          make tools &&
          ls &&
          cd ./../xio-sample-repo/ED64-XIO/ &&
          ls &&
          make ${{ matrix.releasetype }}

      #     sudo npm install -g libdragon
      #     libdragon init
      #     #libdragon exec bash -c 'export N64_CFLAGS="-DNDEBUG"'
      #     #libdragon exec bash -c N64_CFLAGS="-DNDEBUG"
      #     #N64_CFLAGS="-DNDEBUG" && libdragon install
      #     sed -z -i.bak 's/CFLAGS+=$(N64_CFLAGS) /CFLAGS+=$(N64_CFLAGS) -DNDEBUG /' ./libdragon/Makefile
      #     sed -z -i.bak 's/#define assertf(expr, msg, ...)    ({ })/#define assertf(expr, msg, ...)    ({ (void)(expr); })/' ./libdragon/include/debug.h
      #     sed -z -i.bak '1s/^/#undef NDEBUG\n/' ./libdragon/src/debug.c
      #     sed -z -i.bak 's/bool direction = (out<=in);/bool direction = (out<=in); (void)direction;/' ./libdragon/src/audio/libxm/context.c
      #     sed -z -i.bak 's/assert(sz == dec_size);/assert(sz == dec_size); (void)sz;/' ./libdragon/src/audio/libxm/play.c
      #     libdragon install
      #     libdragon start

      - name: Upload Artifact
        uses: actions/upload-artifact@v1.0.0
        with:
          name: ED64-XIO-SAMPLE_N64_ROM-${{ matrix.releasetype }}
          path: ${{ github.workspace }}/**/ED64-XIO/bin/${{ matrix.releasetype }}/ED64-XIO-SAMPLE.v64
